#!/bin/bash -x


STORAGE=/storage/zram

if [[ $# -ne 2 ]]; then echo "$(basename "$0"): wrong usage ! Arguments: sync|recover <dir>"; exit 1; fi

dir=$2

if [[ "$1" = "recover" ]]; then
	rsync -avrh "${dir}/" /
else
	if [[ ! -f /etc/ztab ]] || [[ "$1" != "sync" ]]; then echo "FAILED"; exit 1; fi

	if [[ ! -d $STORAGE ]]; then
		mkdir -p "${STORAGE}"
	fi
	while read -r line; do
		case "$line" in
			"#"*)
				# Skip comment line
				continue
				;;
			"")
				# Skip empty line
				continue
				;;
			*)
				set -- $line
				if [[ "$1" = "dir" ]]; then
					rsync -avRh "$5" "${dir}"
				fi
				;;
		esac
	done < /etc/ztab
fi

